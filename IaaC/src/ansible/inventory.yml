- hosts: all
  gather_facts: no
  become: yes
  tasks:
  - name: "Prepare apt cache"
    ignore_errors: yes
    apt:
      autoremove: yes
      autoclean: yes
      update_cache: yes
      cache_valid_time: 86400

- hosts: ci_hosting
  gather_facts: yes
  become: yes
  roles:
    - geerlingguy.docker

  tasks:
    - assert:
        that:
          - ansible_memtotal_mb >= 16000
          - ansible_processor_vcpus >= 4

    - name: Install Maven
      become: yes
      apt:
        name: maven
        state: latest

    - name: Copy ci-docker-compose file
      become: yes
      copy:
        src: ci-docker-compose.yml
        dest: /var

    - name: Copy elk-docker-compose file
      become: yes
      copy:
        src: elk-docker-compose.yml
        dest: /var
    - name: Copy logstash.conf file
      become: yes
      copy:
        src: logstash.conf
        dest: /var

    - name: Shut down CI docker containers
      become: yes
      command: docker-compose --file /var/ci-docker-compose.yml down --timeout 60
      register: ci_shutdown_console
    - debug: msg="{{ ci_shutdown_console.stdout }}"
    - debug: msg="{{ ci_shutdown_console.stderr }}"

    - name: Shut down ELK docker containers
      become: yes
      command: docker-compose --file /var/elk-docker-compose.yml down --timeout 60
      register: elk_shutdown_console
    - debug: msg="{{ elk_shutdown_console.stdout }}"
    - debug: msg="{{ elk_shutdown_console.stderr }}"

    - name: Build and start up CI docker containers
      become: yes
      command: docker-compose --file /var/ci-docker-compose.yml up --detach
      register: ci_startup_console
    - debug: msg="{{ ci_startup_console.stdout }}"
    - debug: msg="{{ ci_startup_console.stderr }}"

    - name: Build and start up ELK docker containers
      become: yes
      command: docker-compose --file /var/elk-docker-compose.yml up --detach
      register: elk_startup_console
    - debug: msg="{{ elk_startup_console.stdout }}"
    - debug: msg="{{ elk_startup_console.stderr }}"
