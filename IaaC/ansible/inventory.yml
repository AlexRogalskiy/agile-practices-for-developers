- hosts: all
  gather_facts: no
  become: yes

  tasks:
  - name: "Prepare apt cache"
    ignore_errors: yes
    apt:
      autoremove: yes
      autoclean: yes
      update_cache: yes
      cache_valid_time: 86400


- hosts: ci_hosting
  gather_facts: yes
  become: yes

  pre_tasks:
    - assert:
        that:
          - ansible_memtotal_mb >= 16000
          - ansible_processor_vcpus >= 4

  roles:
    - role: geerlingguy.docker
      tags:
      - ci
      - elk

  tasks:
    - name: Copy ci-docker-compose file
      tags: ci
      become: yes
      copy:
        src: ci-docker-compose.yml
        dest: /var

    - name: Copy elk-docker-compose file
      tags: elk
      become: yes
      copy:
        src: elk-docker-compose.yml
        dest: /var

    - name: Copy logstash.conf file
      tags: elk
      become: yes
      copy:
        src: logstash.conf
        dest: /var

    - name: Shut down CI docker containers
      tags: ci
      become: yes
      command: docker-compose --file /var/ci-docker-compose.yml down --timeout 60
      register: ci_shutdown_console
    - debug: msg="{{ ci_shutdown_console.stdout }}"
    - debug: msg="{{ ci_shutdown_console.stderr }}"

    - name: Shut down ELK docker containers
      tags: elk
      become: yes
      command: docker-compose --file /var/elk-docker-compose.yml down --timeout 60
      register: elk_shutdown_console
    - debug: msg="{{ elk_shutdown_console.stdout }}"
    - debug: msg="{{ elk_shutdown_console.stderr }}"

    - name: Build and start up CI docker containers
      tags: ci
      become: yes
      command: docker-compose --file /var/ci-docker-compose.yml up --detach
      register: ci_startup_console
    - debug: msg="{{ ci_startup_console.stdout }}"
    - debug: msg="{{ ci_startup_console.stderr }}"

    - name: Build and start up ELK docker containers
      tags: elk
      become: yes
      command: docker-compose --file /var/elk-docker-compose.yml up --detach
      register: elk_startup_console
    - debug: msg="{{ elk_startup_console.stdout }}"
    - debug: msg="{{ elk_startup_console.stderr }}"


- hosts: ci_agent
  gather_facts: yes
  become: yes

  pre_tasks:
    - assert:
        that:
          - ansible_memtotal_mb >= 2000
          - ansible_processor_vcpus >= 1

    - name: Ensure group "bambooagent" exists (due to bug in mimacom.bamboo-agent)
      tags: bamboo_agent
      group:
        name: bambooagent
        state: present

  roles:
    - role: lean_delivery.java
      tags: java
      transport: repositories
      java_package: jdk
      java_major_version: 8

    - role: gantsign.maven
      tags: maven
      maven_version: '3.6.2'
      maven_is_default_installation: yes

    - role: mimacom.bamboo-agent
      tags: bamboo_agent
      bamboo_agent_remote: true
      bamboo_master_version: 6.10.3
      bamboo_master_fqdn: "{{hostvars['ci_hosting'].ansible_host}}"
      bamboo_master_https: false
      bamboo_master_port: 8085
      bamboo_agent_user: bambooagent
      bamboo_agent_uid: 5000
      bamboo_agent_jvm_memory: 2048m
      install_jdk: false
      bamboo_agent_capabilities:
        - name: jdk8
          binary_path: /usr/lib/jvm/java-8-openjdk-amd64
          symlinks: []
          properties:
            - key: system.jdk.JDK\ 1.8
              value: /usr/lib/jvm/java-8-openjdk-amd64
        - name: mvn3
          binary_path: /opt/maven/apache-maven-3.6.2
          symlinks: []
          properties:
            - key: system.builder.mvn3.Maven\ 3.6
              value: /opt/maven/apache-maven-3.6.2

  tasks:
    - name: Copy custom maven settings file to bamboo_agent home directory
      tags:
        - bamboo_agent
        - maven
      copy:
        src: maven-settings.xml
        dest: /home/bambooagent/.m2/settings.xml
        owner: bambooagent
        group: bambooagent
        mode: '0530'


- hosts: pre_prod
  gather_facts: yes
  become: yes

  pre_tasks:
    - assert:
        that:
          - ansible_memtotal_mb >= 6000
          - ansible_processor_vcpus >= 2

    - name: Ensure group "bambooagent" exists (due to bug in mimacom.bamboo-agent)
      tags: bamboo_agent
      group:
        name: bambooagent
        state: present

  roles:
    - role: lean_delivery.java
      tags: java
      transport: repositories
      java_package: jre
      java_major_version: 8

    - role: gantsign.maven
      tags: maven
      maven_version: '3.6.2'
      maven_is_default_installation: yes

    - role: mimacom.bamboo-agent
      tags: bamboo_agent
      bamboo_agent_remote: true
      bamboo_master_version: 6.10.3
      bamboo_master_fqdn: "{{hostvars['ci_hosting'].ansible_host}}"
      bamboo_master_https: false
      bamboo_master_port: 8085
      bamboo_agent_user: bambooagent
      bamboo_agent_uid: 5000
      bamboo_agent_jvm_memory: 1024m
      install_jdk: false
      bamboo_agent_capabilities:
        - name: mvn3
          binary_path: /opt/maven/apache-maven-3.6.2
          symlinks: []
          properties:
            - key: system.builder.mvn3.Maven\ 3.6
              value: /opt/maven/apache-maven-3.6.2
        - name: service-restarter
          symlinks: []
          properties:
            - key: system.service-restarter.executable
              value: sudo service dbo-app restart

  vars:
    db_user: dbo
    db_password: P@ssw0rd
    databases:
      - name: dbo-db-0
      - name: dbo-db-1
      - name: dbo-db-2
      - name: dbo-db-3
      - name: dbo-db-4
      - name: dbo-db-5
      - name: dbo-db-6
      - name: dbo-db-7
      - name: dbo-db-8
      - name: dbo-db-9

  tasks:
    - name: Create user 'dboadmin'
      tags: distr
      user:
        comment: OS user to deploy and run dbo application
        name: dboadmin
        group: admin

    - name: Create dir for application distr
      tags: distr
      file:
        path: /dbo
        state: directory
        owner: dboadmin
        group: admin
        mode: u=rw,g=rw,o=
        recurse: yes

    - name: Add 'bambooagent' user to 'admin' group in order to manage distr
      tags: bamboo_agent
      user:
        name: bambooagent
        groups: admin
        append: yes

    - name: Create placehlder for application distr in order to make link for daemon system
      tags: distr
      file:
        path: /dbo/dbo-1.0-SNAPSHOT.jar
        state: touch
        owner: dboadmin
        group: admin
        mode: u=rw,g=rw,o=

    - name: Create a symbolic link for application distr for daemon system
      tags: distr
      become: yes
      file:
        src: /dbo/dbo-1.0-SNAPSHOT.jar
        dest: /etc/init.d/dbo-app
        state: link

    - name: Copy custom maven settings file to bamboo_agent home directory
      tags: bamboo_agent
      copy:
        src: maven-settings.xml
        dest: /home/bambooagent/.m2/settings.xml
        owner: bambooagent
        group: bambooagent
        mode: '0530'

    - name: Install Postgres and dependencies
      tags: postgres
      apt:
        name: "{{item}}"
      with_items:
        - postgresql
        - postgresql-contrib
        - libpq-dev
        - python3-psycopg2

    - name: Ensure the PostgreSQL service is running
      tags: postgres
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Create databases
      tags: postgres
      become: true
      become_user: postgres
      postgresql_db:
        name: "{{item.name}}"
        state: present
      with_items: "{{databases}}"

    - name: Create db user and grant access to databases
      tags: postgres
      become: true
      become_user: postgres
      postgresql_user:
        db: "{{item.name}}"
        name: "{{db_user}}"
        password: "{{db_password}}"
        priv: ALL
        state: present
      with_items: "{{databases}}"
